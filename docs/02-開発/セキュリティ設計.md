# セキュリティ設計

## 概要

FC-CRM Systemにおけるセキュリティ対策とBasic認証システムの設計書

## 認証システム

### Basic認証（クライアントサイド）

GitHub Pagesは静的ファイルのみ対応のため、JavaScriptベースの認証を実装

#### 認証情報
```javascript
// デフォルト認証情報（本番では変更必須）
users: [
    {
        username: 'admin',
        password: 'fc-crm-2024!',
        role: 'admin',
        name: '管理者'
    },
    {
        username: 'demo',
        password: 'demo123',
        role: 'viewer',
        name: 'デモユーザー'
    }
]
```

#### セッション管理
- **保存場所**: localStorage
- **有効期限**: 8時間
- **自動更新**: 30分間隔
- **トークン**: Base64エンコードされた一意識別子

### セキュリティ機能

#### 1. 認証ガード
- 全ページで自動認証チェック
- 未認証時は自動ログインページリダイレクト
- セッション期限切れ時の自動ログアウト

#### 2. セッション管理
- 自動セッション更新
- 期限切れ警告（30分前）
- ログアウト時のデータクリア

#### 3. パスワード強度チェック
- リアルタイム強度表示
- 8文字以上推奨
- 大文字・小文字・数字・記号の組み合わせ

#### 4. アクティビティログ
- ログイン・ログアウト記録
- ローカルストレージに最大100件保存
- タイムスタンプ・ユーザーエージェント記録

## 権限管理

### ロール定義
```javascript
permissions = {
    viewer: ['read'],
    admin: ['read', 'write', 'delete']
}
```

#### admin（管理者）
- 全機能へのアクセス
- 企業情報の作成・編集・削除
- システム設定の変更
- ログ閲覧

#### viewer（閲覧者）
- 読み取り専用アクセス
- 企業情報の閲覧のみ
- ログの閲覧のみ

### 今後の拡張予定
- **editor**: 編集権限のみ
- **reporter**: レポート閲覧のみ
- **api_user**: API専用アクセス

## データ保護

### 1. ローカルストレージ暗号化
```javascript
// 認証トークンの保護
token: btoa(`${username}:${timestamp}:${random}`)
```

### 2. 機密情報の扱い
- パスワードはプレーンテキスト保存（本番では要改善）
- APIキーは別途暗号化予定
- 個人情報は最小限の保存

### 3. セッション保護
- XSS対策（HTML エスケープ）
- セッション固定攻撃対策
- CSRF対策（今後実装予定）

## 脆弱性対策

### 実装済み対策

#### 1. XSS（Cross-Site Scripting）
```javascript
// HTMLエスケープ関数
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}
```

#### 2. セッション管理
- 自動期限切れ
- ブラウザ終了時のクリア（設定可能）
- 同時ログイン制御（今後実装）

#### 3. 入力値検証
- フロントエンド・バックエンド両方で実装
- 文字数制限
- 形式チェック（メール、URL等）

### 今後実装予定

#### 1. CSRF対策
- CSRFトークンの実装
- SameSite Cookie設定

#### 2. ブルートフォース対策
- ログイン試行回数制限
- IP制限機能

#### 3. 二要素認証
- TOTP（Time-based One-Time Password）
- SMS認証

## GitHub Pages特有の制約

### 制約事項
1. **サーバーサイド処理不可**: PHP等のサーバーサイド言語使用不可
2. **データベース接続不可**: 直接的なDB接続不可
3. **HTTPS強制**: 独自SSL証明書使用不可
4. **静的ファイルのみ**: 動的コンテンツ生成不可

### 対応策
1. **クライアントサイド認証**: JavaScriptベースの認証システム
2. **外部API連携**: 別途ホスティングのAPIサーバーとの連携
3. **ローカルストレージ活用**: セッション・設定データの保存
4. **CDN活用**: Bootstrap、アイコン等は外部CDN使用

## セキュリティレベル評価

### 現在の実装レベル

#### ✅ 実装済み（低リスク対応）
- Basic認証システム
- セッション管理
- XSS対策
- 入力値検証
- アクティビティログ

#### 🔄 部分実装（中リスク対応）
- 権限管理（基本のみ）
- パスワード強度チェック
- セッション期限管理

#### ❌ 未実装（高リスク）
- CSRF対策
- ブルートフォース対策
- 二要素認証
- サーバーサイド認証

### 推奨セキュリティレベル

#### GitHub Pages（デモ・開発用）
- **レベル**: 低〜中
- **用途**: 内部デモ、開発確認
- **制約**: クライアントサイド認証のみ

#### 本番環境（ConoHa WING）
- **レベル**: 中〜高
- **用途**: 実運用
- **要件**: サーバーサイド認証、DB暗号化

## 運用ガイドライン

### 1. パスワード管理
```javascript
// 本番環境では以下を実施
// 1. デフォルトパスワードの変更
// 2. 定期的なパスワード変更（3ヶ月）
// 3. パスワード履歴管理
// 4. 強度基準の厳格化
```

### 2. アクセス制御
- **ネットワーク制限**: VPN経由のみアクセス許可（推奨）
- **時間制限**: 営業時間内のみアクセス許可（オプション）
- **デバイス制限**: 特定デバイスからのみアクセス（オプション）

### 3. 監視・ログ
- **アクセスログ**: 全ログイン試行の記録
- **異常検知**: 異常なアクセスパターンの検知
- **定期レビュー**: 月次でのログレビュー

### 4. インシデント対応
```markdown
## インシデント発生時の対応手順
1. **即座のアクセス停止**: 該当アカウントの無効化
2. **ログ確認**: アクセスログの詳細分析
3. **影響範囲調査**: 漏洩・改ざんデータの特定
4. **復旧作業**: セキュリティ修正後のサービス復旧
5. **再発防止**: セキュリティ対策の強化
```

## 開発・テスト用認証情報

### GitHub Pages公開用
```
管理者アカウント:
- ユーザー名: admin
- パスワード: fc-crm-2024!
- 権限: 全機能

閲覧者アカウント:
- ユーザー名: demo
- パスワード: demo123
- 権限: 読み取りのみ
```

### セキュリティ注意事項
⚠️ **重要**: この認証情報は開発・デモ用です
- 本番環境では必ず変更してください
- 定期的なパスワード変更を実施してください
- 不要になったアカウントは速やかに削除してください

## 技術仕様

### 実装ファイル
- `js/auth.js`: 認証管理クラス
- `login.html`: ログインページ
- 各ページ: 認証ガード組み込み

### 依存関係
- Bootstrap 5.3.0
- localStorage API
- Base64エンコーディング

### ブラウザ対応
- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

## 関連ドキュメント
- [[技術メモ#セキュリティ対策]]
- [[システム設計書#セキュリティ]]
- [[運用マニュアル#アクセス制御]]